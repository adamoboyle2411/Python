import pygame
from sys import exit
from random import randint, choice

class PlayerClass(pygame.sprite.Sprite):
	def __init__(Self):
		super().__init__()
		PlayerWalk1 = pygame.image.load("graphics/player/player_walk_1.png").convert_alpha()
		PlayerWalk2 = pygame.image.load("graphics/player/player_walk_2.png").convert_alpha()
		Self.PlayerWalk = [PlayerWalk1, PlayerWalk2]
		Self.PlayerIndex = 0
		Self.PlayerJump = pygame.image.load("graphics/player/jump.png").convert_alpha()
		Self.Image = Self.PlayerWalk[Self.PlayerIndex]
		Self.Rectangle = Self.Image.get_rect(midbottom = (80, 300))
		Self.Gravity = 0
		Self.JumpSound = pygame.mixer.Sound("audio/jump.mp3")
		Self.JumpSound.set_volume(0.5)
	def PlayerInput(Self):
		Keys = pygame.key.get_pressed()
		if Keys[pygame.K_SPACE] and Self.Rectangle.bottom >= 300:
			Self.Gravity = -20
			Self.JumpSound.play()
	def ApplyGravity(Self):
		Self.Gravity += 1
		Self.Rectangle.y += Self.Gravity
		if Self.Rectangle.bottom >= 300:
			Self.Rectangle.bottom = 300
	def AnimationState(Self):
		if Self.Rectangle.bottom < 300: 
			Self.Image = Self.PlayerJump
		else:
			Self.PlayerIndex += 0.1
			if Self.PlayerIndex >= len(Self.PlayerWalk):Self.PlayerIndex = 0
			Self.Image = Self.PlayerWalk[int(Self.PlayerIndex)]
	def Update(Self):
		Self.PlayerInput()
		Self.ApplyGravity()
		Self.AnimationState()

class ObstacleClass(pygame.sprite.Sprite):
	def __init__(Self, Type):
		super().__init__()
		if Type == 'Fly':
			Fly1 = pygame.image.load("graphics/fly/fly1.png").convert_alpha()
			Fly2 = pygame.image.load("graphics/fly/fly2.png").convert_alpha()
			Self.Animaion = [Fly1, Fly2]
			YPosition = 210
		else:
			Snail1 = pygame.image.load("graphics/snail/snail1.png").convert_alpha()
			Snail2 = pygame.image.load("graphics/snail/snail2.png").convert_alpha()
			Self.Animation = [Snail1, Snail2]
			YPosition = 300
		Self.AnimationIndex = 0
		Self.Image = Self.Animation[Self.AnimationIndex]
		Self.Rectangle = Self.Image.get_rect(midbottom = (randint(900, 1100), YPosition))
	def AnimationState(Self):
		Self.AnimationIndex += 0.1 
		if Self.AnimationIndex >= len(Self.Animation): Self.AnimationIndex = 0
		Self.Image = Self.Animation[int(Self.AnimationIndex)]
	def Destroy(Self):
		if Self.Rectangle.x <= -100: 
			Self.kill()
	def Update(Self):
		Self.AnimationState()
		Self.Rectangle.x -= 6
		Self.Destroy()

def DisplayScore():
	CurrentTime = int(pygame.time.get_ticks() / 1000) - StartTime
	ScoreSurface = test_font.render(f"Score: {CurrentTime}", False, (64,64,64))
	ScoreRectangle = ScoreSurface.get_rect(center = (400, 50))
	Screen.blit(ScoreSurface, ScoreRectangle)
	return CurrentTime

def CollisionSprite():
	if pygame.sprite.spritecollide(player.sprite, ObstacleGroup, False):
		ObstacleGroup.empty()
		return False
	else:
		return True

pygame.init()
Screen = pygame.display.set_mode((800,400))
pygame.display.set_caption("Adam's Game")
Clock = pygame.time.Clock()
Font = pygame.font.Font("font/Pixeltype.ttf", 50)
GameActive = False
StartTime = 0
Score = 0
BackgroundMusic = pygame.mixer.Sound("audio/music.wav")
BackgroundMusic.play(loops = -1)

Player = pygame.sprite.GroupSingle()
Player.add(PlayerClass())

ObstacleGroup = pygame.sprite.Group()

SkySurface = pygame.image.load("graphics/Sky.png").convert()
GroundSurface = pygame.image.load("graphics/ground.png").convert()

EndPlayer = pygame.image.load("graphics/player/player_stand.png").convert_alpha()
EndPlayer = pygame.transform.rotozoom(EndPlayer, 0, 2)
EndPlayerRectangle = EndPlayer.get_rect(center = (400, 200))

GameName = Font.render("GAME", False, (111, 196, 169))
GameNameRectangle = GameName.get_rect(center = (400, 80))

GameMessage = Font.render("Press space to play again", False, (111,196,169))
GameMessageRectangle = GameMessage.get_rect(center = (400, 350))

ObstacleTimer = pygame.USEREVENT + 1
pygame.time.set_timer(obstacle_timer,1500)

while True:

	for CurrentEvent in pygame.event.get():
		if CurrentEvent.type == pygame.QUIT:
			pygame.quit()
			exit()
		elseif GameActive and CurrentEvent.type == ObstacleTimer:
			ObstacleGroup.add(ObstacleClass(choice(["Fly", "Snail", "Snail", "Snail"])))
		elseif not GameActive:
			if CurrentEvent.type == pygame.KEYDOWN and CurrentEvent.key == pygame.K_SPACE:
				GameActive = True
				StartTime = int(pygame.time.get_ticks() / 1000)

	if GameActive:

		Screen.blit(SkySurface, (0, 0))
		Screen.blit(GroundSurface, (0, 300))
		Score = DisplayScore()
		
		Player.draw(Screen)
		Player.Update()

		ObstacleGroup.draw(Screen)
		ObstacleGroup.Update()

		GameActive = CollisionSprite()
		
	else:

		Screen.fill((94, 129, 162))
		Screen.blit(EndPlayer, EndPlayerRectangle)

		ScoreMessage = Font.render(f"Your score: {Score}", False, (111, 196, 169))
		ScoreMessageRectangle = ScoreMessage.get_rect(center = (400, 320))

		Screen.blit(GameName, GameNameRectangle)
		Screen.blit(ScoreMessage, ScoreMessageRectangle)
		Screen.blit(GameMessage, GameMessageRectangle)

	pygame.display.update()
	Clock.tick(60)
